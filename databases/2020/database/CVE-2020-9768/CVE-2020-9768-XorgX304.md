# CVE-2020-9768

AppleJPEGDriverUserClient : mach port use-after-free/type-confusion via race condition

| Infos    | Value                                                              |
| -------- | -------------------------------------------------------------------|
| Username | [https://github.com/XorgX304](https://github.com/XorgX304) |
| Url      | [https://github.com/XorgX304/CVE-2020-9768](https://github.com/XorgX304/CVE-2020-9768)                                               |
| Stars    | 0                                                          |
| License  | No License                                                        |

<details>

<summary>Topic / Tags</summary>



</details>

## Readme

# CVE-2020-9768
AppleJPEGDriverUserClient : mach port use-after-free/type-confusion via race condition

AppleJPEGDriverUserClient external methods can be used synchronously or asynchronously, when used asynchronously, 
it brings the registered mach port (via registerNotificationPort()) and put it inside jpegRequest data structure,
and no reference count was taken for this operation. since registerNotificationPort() is not gated, it is 
possible to release the port (if the port got substituted)  during the processing of jpeg request and end up
with dangling pointer passed to _mach_msg_send_from_kernel_proper().

Note that the race window can be expanded by providing some valid inputs, and by calling several synchronous
calls first, we can fill the jpeg request queue (see  AppleJPEGDriver::queue_io_gated)  and force the asynchronous
call to be delayed, so the port could be replaced.

Fix :	Apple removed releaseNotificationPort() from registerNotificationPort() and prevented port substitution.
Actual for iOS 13.0 - 13.3.1. Fixed in iOS 13.4.



## Get the content

```
git clone https://github.com/XorgX304/CVE-2020-9768
cd CVE-2020-9768
```

{% embed url="https://github.com/XorgX304/CVE-2020-9768" %}

<figure><img src="https://avatars.githubusercontent.com/u/46254011?v=4" alt=""><figcaption><p>XorgX304</p></figcaption></figure>
